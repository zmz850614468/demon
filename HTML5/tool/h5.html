<!DOCTYPE HTML>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>电商售后工具</title>
<!-- 
    <script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.js"></script>
    <script src="https://cdn.bootcss.com/xlsx/0.11.5/xlsx.core.min.js"></script> -->

    <script src="jquery.js"></script>
    <script src="xlsx.core.min.js"></script>
<style>
    .sty{
        padding-left: 20px;
        padding-top: 5px;
    }
</style>
    <script>

        // class DaHuiBean{
        //     id
        //     address
        //     count
        // }
        // import XLSX from 'xlsx';

        var selectType="1";
        var selectedFile = null;

        function onTypeSelect(value){
           selectType = value;    
            if(selectedFile !=null){
                readFile()
            }
        }

        function selectFile(e){
            selectedFile = e.target.files[0];

            // console.log(JSON.stringify(e.target.files))

            readFile();
        }

        function readFile(){
            var fileReader = new FileReader();
                        fileReader.onload = function(ev) {
                                var data = ev.target.result
                                var workbook = XLSX.read(data, {
                                    type: 'binary'
                                }) // 以二进制流方式读取得到整份excel表格对象
                                var worksheet = workbook.Sheets[workbook.SheetNames[0]];
                                var json = XLSX.utils.sheet_to_json(worksheet,{header:1})

                                if(selectType =="1"){
                                    jingDong(json)
                                }else if(selectType=="2"){
                                    daHui(json)
                                }

                        };
                        // 以二进制方式打开文件
                        fileReader.readAsBinaryString(selectedFile);
        }


    // 处理打回数据
    function daHui(json){
        var map = new Map()

        var inputCount =0
        for(var i=2; i< json.length;i++){
            if(json[i].length > 5 && json[i][2]!=""){
                if(map.has(json[i][2])){
                    map.get(json[i][2]).count++
                }else{
                    map.set(json[i][2], {"id":json[i][2],"address":json[i][4],"count":1})
                }
                inputCount++
            }
        }

        // 迭代 Map 中的 value
        console.log("size:"+ map.size)
        // for (var value of map.values()) {
        //     console.log(value);                 
        // }

        var addressArr = ["河北","山东","辽宁","黑龙江","吉林","甘肃","青海","河南","江苏","湖北","湖南","江西","浙江","广东","云南","福建","台湾","海南","山西","四川","陕西","贵州","安徽","重庆","北京","上海","天津","广西","内蒙","西藏","新疆","澳门","香港"]
        var addressMap = new Map()
        var maxSize = 0
        for (var address of addressArr) {
            for (var value of map.values()) {
                if(value.address.indexOf(address) !=-1 ||(address=="云南" && value.address.indexOf("昆明")!=-1)||
                (address=="四川" && value.address.indexOf("成都")!=-1) || (address=="山东" && value.address.indexOf("济南")!=-1) || 
                (address=="江苏" && value.address.indexOf("扬州")!=-1) ||(address=="河南" && value.address.indexOf("商丘")!=-1)||
                (address=="江苏" && value.address.indexOf("苏州")!=-1) || (address=="陕西" && value.address.indexOf("西安")!=-1)|| 
                (address=="安徽" && value.address.indexOf("淮北")!=-1) || (address=="江苏" && value.address.indexOf("徐州")!=-1)||
                (address=="河南" && value.address.indexOf("郑州")!=-1) ){   // 特殊处理
                    if(addressMap.has(address)){
                        addressMap.get(address).push(value)
                        maxSize = Math.max(maxSize, addressMap.get(address).length)
                    }else{
                        var a = []
                        a.push(value)
                        addressMap.set(address, a)
                    }
                }               
            }
        }

        // 打印结果
        var result = document.getElementById('result')
        result.innerHTML = "";

        var yfpTotal = 0
        for(var item of addressMap.values()){
            yfpTotal += getTotal(item)
        }
        var newDiv = document.createElement("div");
        newDiv.innerHTML =  "文件数据共："+ inputCount + "条 <br> 已分配数据共："+yfpTotal+"条<br> <br> "; // 设置 div 内容
        result.appendChild(newDiv); // 将 div 添加到 body 中

        // console.log("maxSize:"+ maxSize)
        var count =1;
        while(maxSize > 0){
            addressMap.forEach(function(value, key){
                if(maxSize == value.length){
                    var newDiv = document.createElement("div");
                    newDiv.innerHTML =  count++ +"\t--\t"+ key +"\t--\t"+ maxSize +"单\t--\t"+ getTotal(value) + "件"; // 设置 div 内容
                    result.appendChild(newDiv); // 将 div 添加到 body 中

                    var outCout = 0
                    var i=1
                    while(true){
                        for(var item of value){
                            if(i == item.count){
                                newDiv = document.createElement("div");
                                newDiv.innerHTML =  item.id +"\t--\t"+ item.count +"\t--\t"+item.address; // 设置 div 内容
                                result.appendChild(newDiv); // 将 div 添加到 body 中
                                outCout++
                            }
                        }
                        i++
                        if(outCout == value.length){
                            break
                        }
                    }

                    // for(var item of value){
                    //     newDiv = document.createElement("div");
                    //     newDiv.innerHTML =  item.id +"\t--\t"+ item.count +"\t--\t"+item.address; // 设置 div 内容
                    //     result.appendChild(newDiv); // 将 div 添加到 body 中
                    // }

                    newDiv = document.createElement("br");
                    result.appendChild(newDiv); // 将 div 添加到 body 中
                }
            },addressMap)
            maxSize--
        }
    }

    function getTotal(arr){
        var count =0
        for(var item of arr){
            count += item.count
        }
        return count
    }
    

    // 处理京东重复数据
    function jingDong(json){
        var wcsResult =[];
        var otherResult = [];
        for(var i=0; i< json.length;i++){
            if(json[i].length >= 5 && json[i][1].indexOf("京东")!=-1 && json[i][2].indexOf("-")==-1){
                if(json[i][4]=="wcs"){
                    wcsResult.push(json[i]);
                }else{
                    otherResult.push(json[i]);
                }
            }
        }

        var result = document.getElementById('result')
        result.innerHTML = "";
        var count =1;
        for(var i=0; i< wcsResult.length;i++){
            // console.log(i+" - "+wcsResult[i]);
            // 创建一个新的 div 元素节点
            var newDiv = document.createElement("div");
            newDiv.innerHTML =  count++ +"\t--\t"+ wcsResult[i][2] +"\t--\t"+ wcsResult[i][4]; // 设置 div 内容
            result.appendChild(newDiv); // 将 div 添加到 body 中
        }
        for(var i=0; i< otherResult.length;i++){
            // console.log(i+" - "+otherResult[i]);
             // 创建一个新的 div 元素节点
            var newDiv = document.createElement("div");
            newDiv.innerHTML =  count++ +"\t--\t"+ otherResult[i][2] +"\t--\t"+ otherResult[i][4]; // 设置 div 内容
            result.appendChild(newDiv); // 将 div 添加到 body 中
        }
    }
    </script>

</head>
<body class="sty">
<p>
    <label>请选择处理的文件类型</label>
    <br>

    <input id="rad" type="radio" checked name="rad" onchange="onTypeSelect(1)" />
    <label for="rad">京东大小码</label>

    <input id="rad2" type="radio" name="rad" onchange="onTypeSelect(2)"/>
    <label for="rad2">打回数据整合</label>

    <br>
    <br>

    文件选择: <input type="file" id="xlf"><br>
</p>

<p id="result"></p>
<!--<input type="button" onclick="handleFile()" value="解析文件"><br>-->
<script>
    document.getElementById('xlf').addEventListener('change', selectFile, false);
</script>

</body>
</html>